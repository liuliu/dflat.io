


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://dflat.io/getting-started/">
      
      
        <meta name="author" content="Liu Liu">
      
      <link rel="shortcut icon" href="../favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>Getting Started - 「Dflat」Structured Data Store for Mobile</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fe0cca5b.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#7e57c2">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#installation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://dflat.io" title="「Dflat」Structured Data Store for Mobile" class="md-header-nav__button md-logo" aria-label="「Dflat」Structured Data Store for Mobile">
      
  <img src="../images/logo.svg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            「Dflat」Structured Data Store for Mobile
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Getting Started
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/liuliu/dflat" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    liuliu/dflat
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    
  </li>

      
        
      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../runtime-api/" class="md-tabs__link">
          API Reference
        </a>
      
    </li>
  

      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://dflat.io" title="「Dflat」Structured Data Store for Mobile" class="md-nav__button md-logo" aria-label="「Dflat」Structured Data Store for Mobile">
      
  <img src="../images/logo.svg" alt="logo">

    </a>
    「Dflat」Structured Data Store for Mobile
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/liuliu/dflat" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    liuliu/dflat
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Getting Started
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Getting Started" class="md-nav__link md-nav__link--active">
      Getting Started
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../runtime-api/" title="API Reference / Runtime API" class="md-nav__link">
      API Reference / Runtime API
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      API Reference
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="API Reference" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        API Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-api/" title="Runtime API" class="md-nav__link">
      Runtime API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reference/Workspace/" title="Workspace" class="md-nav__link">
      Workspace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reference/TransactionContext/" title="TransactionContext" class="md-nav__link">
      TransactionContext
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reference/SQLiteWorkspace/" title="SQLiteWorkspace" class="md-nav__link">
      SQLiteWorkspace
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schema/" title="Schema Evolution" class="md-nav__link">
      Schema Evolution
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../namespace/" title="Namespace" class="md-nav__link">
      Namespace
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../benchmark/" title="Benchmark" class="md-nav__link">
      Benchmark
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../acknowledgement/" title="Acknowledgement" class="md-nav__link">
      Acknowledgement
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Getting Started</h1>
                
                <p><strong>Dflat</strong> consists two parts:</p>
<ol>
<li>
<p><code>dflatc</code> compiler that takes a <a href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html">flatbuffers schema</a> and generate Swift code from it;</p>
</li>
<li>
<p><strong>Dflat</strong> runtime with very minimal API footprint to interact with.</p>
</li>
</ol>
<p>The <strong>Dflat</strong> runtime uses SQLite as the storage backend. The design itself can support other backends such as <a href="https://github.com/erthink/libmdbx">libmdbx</a> in the future. The only hard dependency is flatbuffers.</p>
<p>To use <strong>Dflat</strong>, you should first use <code>dflatc</code> compiler to generate data model from flatbuffers schema, include the generated code in your project, and then use <strong>Dflat</strong> runtime to interact with the data models.</p>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<p><strong>Dflat</strong> at the moment requires <a href="https://github.com/bazelbuild/bazel">Bazel</a>. To be more precise, <strong>Dflat</strong> runtime can be installed with either <a href="https://swift.org/package-manager/">Swift Package Manager</a> or Bazel. But the <code>dflatc</code> compiler requires Bazel to build relevant parts.</p>
<p>You can install Bazel on macOS following <a href="https://docs.bazel.build/versions/3.3.0/install-os-x.html">this guide</a>.</p>
<p>After that, you can use <code>dflatc</code> compiler with</p>
<div class="codehilite"><pre><span></span><code><span class="err">./dflatc.py --help</span>
</code></pre></div>


<p>You can then proceed to add <strong>Dflat</strong> runtime either with Swift Package Manager or Bazel. With Swift Package Manager:</p>
<div class="codehilite"><pre><span></span><code><span class="p">.</span><span class="n">package</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;Dflat&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="s">&quot;https://github.com/liuliu/dflat.git&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">branch</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">))</span>
</code></pre></div>


<h2 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h2>
<p>Assuming you have a <code>post.fbs</code> file somewhere look like this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">enum</span><span class="w"> </span><span class="nl">Color</span><span class="p">:</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">Green</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">Blue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="nc">table</span><span class="w"> </span><span class="n">TextContent</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="nc">text</span><span class="err">:</span><span class="w"> </span><span class="n">string</span><span class="p">;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="nc">table</span><span class="w"> </span><span class="n">ImageContent</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="nl">images</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="p">;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="ow">union</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">TextContent</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">ImageContent</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="nc">table</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="nl">title</span><span class="p">:</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="p">(</span><span class="k">primary</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"></span>
<span class="w">  </span><span class="nl">color</span><span class="p">:</span><span class="w"> </span><span class="n">Color</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="nl">tag</span><span class="p">:</span><span class="w"> </span><span class="n">string</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="nl">priority</span><span class="p">:</span><span class="w"> </span><span class="nc">int</span><span class="w"> </span><span class="p">(</span><span class="n">indexed</span><span class="p">);</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">property</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">indexed</span><span class="w"></span>
<span class="w">  </span><span class="nl">content</span><span class="p">:</span><span class="w"> </span><span class="n">Content</span><span class="p">;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">root_type</span><span class="w"> </span><span class="n">Post</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">important</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="k">object</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">Dflat</span><span class="w"> </span><span class="n">manages</span><span class="p">.</span><span class="w"></span>
</code></pre></div>


<p>You can then use <code>dflatc</code> compiler to generate code from the schema:</p>
<div class="codehilite"><pre><span></span><code><span class="err">./dflatc.py -o ../PostExample ../PostExample/post.fbs</span>
</code></pre></div>


<p>If everything checks out, you should see 4 files generated in <code>../PostExample</code> directory: <code>post_generated.swift</code>, <code>post_data_model_generated.swift</code>, <code>post_mutating_generated.swift</code>, <code>post_query_generated.swift</code>. Adding them to your project.</p>
<p>Now you can do basic Create-Read-Update-Delete (CRUD) operations on the <code>Post</code> object.</p>
<div class="codehilite"><pre><span></span><code><span class="kd">import</span> <span class="nc">Dflat</span>
<span class="kd">import</span> <span class="nc">SQLiteDflat</span>

<span class="kd">let</span> <span class="nv">dflat</span> <span class="p">=</span> <span class="n">SQLiteWorkspace</span><span class="p">(</span><span class="n">filePath</span><span class="p">:</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">fileProtectionLevel</span><span class="p">:</span> <span class="p">.</span><span class="n">noProtection</span><span class="p">)</span>
</code></pre></div>


<p>Create:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">var</span> <span class="nv">createdPost</span><span class="p">:</span> <span class="n">Post</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>
<span class="n">dflat</span><span class="p">.</span><span class="n">performChanges</span><span class="p">([</span><span class="n">Post</span><span class="p">.</span><span class="kc">self</span><span class="p">],</span> <span class="n">changesHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">txnContext</span><span class="p">)</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="nv">creationRequest</span> <span class="p">=</span> <span class="n">PostChangeRequest</span><span class="p">.</span><span class="n">creationRequest</span><span class="p">()</span>
  <span class="n">creationRequest</span><span class="p">.</span><span class="n">title</span> <span class="p">=</span> <span class="s">&quot;first post&quot;</span>
  <span class="n">creationRequest</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="p">.</span><span class="n">red</span>
  <span class="n">creationRequest</span><span class="p">.</span><span class="n">content</span> <span class="p">=</span> <span class="p">.</span><span class="n">textContent</span><span class="p">(</span><span class="n">TextContent</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="s">&quot;This is my very first post!&quot;</span><span class="p">))</span>
  <span class="k">guard</span> <span class="kd">let</span> <span class="nv">inserted</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">txnContent</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">creationRequest</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span> <span class="c1">// Alternatively, you can use txnContent.try(submit: creationRequest) which won&#39;t return any result and do &quot;reasonable&quot; error handling.</span>
  <span class="k">if</span> <span class="k">case</span> <span class="kd">let</span> <span class="p">.</span><span class="n">inserted</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="p">=</span> <span class="n">inserted</span> <span class="p">{</span>
    <span class="n">createdPost</span> <span class="p">=</span> <span class="n">post</span>
  <span class="p">}</span>
<span class="p">})</span> <span class="p">{</span> <span class="n">succeed</span> <span class="k">in</span>
  <span class="c1">// Transaction Done</span>
<span class="p">}</span>
</code></pre></div>


<p>Read:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span> <span class="nv">posts</span> <span class="p">=</span> <span class="n">dflat</span><span class="p">.</span><span class="n">fetchFor</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="kc">self</span><span class="p">).</span><span class="k">where</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">title</span> <span class="p">==</span> <span class="s">&quot;first post&quot;</span><span class="p">)</span>
</code></pre></div>


<p>Update:</p>
<div class="codehilite"><pre><span></span><code><span class="n">dflat</span><span class="p">.</span><span class="n">performChanges</span><span class="p">([</span><span class="n">Post</span><span class="p">.</span><span class="kc">self</span><span class="p">],</span> <span class="n">changesHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">txnContext</span><span class="p">)</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="nv">post</span> <span class="p">=</span> <span class="n">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nv">changeRequest</span> <span class="p">=</span> <span class="n">PostChangeRequest</span><span class="p">.</span><span class="n">changeRequest</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
  <span class="n">changeRequest</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="p">.</span><span class="n">green</span>
  <span class="n">txnContent</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="n">submit</span><span class="p">:</span> <span class="n">changeRequest</span><span class="p">)</span>
<span class="p">})</span> <span class="p">{</span> <span class="n">succeed</span> <span class="k">in</span>
  <span class="c1">// Transaction Done</span>
<span class="p">}</span>
</code></pre></div>


<p>Delete:</p>
<div class="codehilite"><pre><span></span><code><span class="n">dflat</span><span class="p">.</span><span class="n">performChanges</span><span class="p">([</span><span class="n">Post</span><span class="p">.</span><span class="kc">self</span><span class="p">],</span> <span class="n">changesHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">txnContext</span><span class="p">)</span> <span class="k">in</span>
  <span class="kd">let</span> <span class="nv">post</span> <span class="p">=</span> <span class="n">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nv">deletionRequest</span> <span class="p">=</span> <span class="n">PostChangeRequest</span><span class="p">.</span><span class="n">deletionRequest</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
  <span class="n">txnContent</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="n">submit</span><span class="p">:</span> <span class="n">deletionRequest</span><span class="p">)</span>
<span class="p">})</span> <span class="p">{</span> <span class="n">succeed</span> <span class="k">in</span>
  <span class="c1">// Transaction Done</span>
<span class="p">}</span>
</code></pre></div>


<p>You can subscribe changes to either a query, or an object. For an object, the subscription ends when the object was deleted. For queries, the subscription won't complete unless cancelled. There are two sets of APIs for this, one is vanilla callback-based, the other is based on <a href="https://developer.apple.com/documentation/combine">Combine</a>. I will show the <strong>Combine</strong> one here.</p>
<p>Subscribe a live query:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">dflat</span><span class="p">.</span><span class="n">publisher</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">Post</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
  <span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="n">Post</span><span class="p">.</span><span class="n">color</span> <span class="p">==</span> <span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="n">orderBy</span><span class="p">:</span> <span class="p">[</span><span class="n">Post</span><span class="p">.</span><span class="n">priority</span><span class="p">.</span><span class="n">descending</span><span class="p">])</span>
  <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">())</span>
  <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">posts</span> <span class="k">in</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></div>


<p>Subscribe to an object:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">dflat</span><span class="p">.</span><span class="n">pulisher</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">())</span>
  <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">post</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">post</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">updated</span><span class="p">(</span><span class="n">newPost</span><span class="p">):</span>
      <span class="bp">print</span><span class="p">(</span><span class="n">newPost</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">.</span><span class="n">deleted</span><span class="p">:</span>
      <span class="bp">print</span><span class="p">(</span><span class="s">&quot;deleted, this is completed.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href=".." title="Home" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </div>
            </div>
          </a>
        
        
          <a href="../runtime-api/" title="API Reference / Runtime API" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                API Reference / Runtime API
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/liuliu" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 01-1.93.07 4.28 4.28 0 004 2.98 8.521 8.521 0 01-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>